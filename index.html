<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<link rel="stylesheet" type="text/css" href="barStyle.css">
</head>
<body>
	<h1>Cost OverRuns by Agency</h1>
	<div class="bchart">
	</div>
	<script type="text/javascript">
		var keys =
		{
			plannedCost : "Planned Cost ($ M)",
			dollarVariance : "Cost Variance ($ M)",
			percentVariance : "Cost Variance (%)",
			agencyName : "Agency Name"
		};
		var width = 420,
    	barHeight = 20;

		d3.csv("data.csv",function(error,data)
		{
			var nested_data = d3.nest()
				.key(function(d) {return d[keys.agencyName];})
				.entries(data);
			departmentOverruns(nested_data);
			console.log(nested_data);
			drawBarChart(nested_data,keys.percentVariance);

		});

		function drawBarChart(data,key)
		{
			//debugging Dept of labor
			$.each(data[3].values, function (i,d) {
				console.log(d[key]+" "+i);
			});


			var max = d3.max(data, function(d) {return d[key]});
			var min = d3.min(data, function(d) {return d[key]});

		 	console.log(max);
    		var x = d3.scale.linear(max)
    		.domain([min,max ])
    		.range([0, width]);
    		
    		var chart = d3.select(".bchart");
			var bar = chart.selectAll("div");
			bar.data(data)
				.enter().append("div")
			    .style("width", function(d) { return x(d[key])  + "px"; })
			    .text(function(d) { return d.key + d[key]; });
		}

		function departmentOverruns(nested_data)
		{
			$.each(nested_data,function(i,agencyNode)
			{
				var dollarsOver = 0;
				var plannedDollars = 0;
				$.each(agencyNode.values, function(i,leaf)
				{
					var variance = parseFloat(leaf[keys.dollarVariance]);
					if (!isNaN(variance)) 
					{
						dollarsOver = dollarsOver + variance; 
					};

					var cost = parseFloat(leaf[keys.plannedCost]);
					if (!isNaN(cost)) 
					{
						plannedDollars = plannedDollars + cost; 
					};
				});
				var percentageOver = (dollarsOver / plannedDollars) *100;
				agencyNode[keys.dollarVariance] = dollarsOver;
				agencyNode[keys.plannedCost] = plannedDollars;
				agencyNode[keys.percentVariance] = percentageOver;
			});
		}
	</script>
</body>
